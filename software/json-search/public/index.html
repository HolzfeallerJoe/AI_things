<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>JSON Search</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            slate: {
              850: '#172033',
              950: '#0d1320'
            }
          }
        }
      }
    }
  </script>
</head>
<body class="h-full bg-gradient-to-br from-slate-950 via-slate-900 to-slate-950 text-slate-200">
  <div class="min-h-full">
    <!-- Header -->
    <header class="border-b border-slate-800/50 bg-slate-900/50 backdrop-blur-sm sticky top-0 z-50">
      <div class="max-w-7xl mx-auto px-6 py-4">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-cyan-500 to-blue-600 flex items-center justify-center">
            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
            </svg>
          </div>
          <div>
            <h1 class="text-xl font-semibold text-white">JSON Search</h1>
            <p class="text-xs text-slate-400">Upload, search, and export JSON data</p>
          </div>
        </div>
      </div>
    </header>

    <main class="max-w-7xl mx-auto px-6 py-8 pb-48 space-y-6">
      <!-- Upload Section -->
      <section class="bg-slate-900/50 rounded-2xl border border-slate-800/50 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-800/50">
          <h2 class="text-sm font-medium text-slate-300 uppercase tracking-wider">Data Source</h2>
        </div>
        <div class="p-6">
          <div id="uploadArea" class="relative border-2 border-dashed border-slate-700 rounded-xl p-12 text-center cursor-pointer transition-all duration-200 hover:border-cyan-500/50 hover:bg-cyan-500/5 group">
            <input type="file" id="fileInput" accept=".json" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
            <div class="space-y-4">
              <div class="w-16 h-16 mx-auto rounded-2xl bg-slate-800 flex items-center justify-center group-hover:bg-cyan-500/10 transition-colors">
                <svg class="w-8 h-8 text-slate-500 group-hover:text-cyan-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                </svg>
              </div>
              <div>
                <p class="text-slate-300 font-medium">Drop your JSON file here</p>
                <p class="text-sm text-slate-500 mt-1">or click to browse</p>
              </div>
            </div>
          </div>

          <!-- File Info -->
          <div id="fileInfo" class="hidden mt-4 p-4 bg-slate-800/50 rounded-xl border border-slate-700/50">
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-lg bg-emerald-500/10 flex items-center justify-center">
                  <svg class="w-5 h-5 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                  </svg>
                </div>
                <div>
                  <p class="font-medium text-white" id="fileName">-</p>
                  <p class="text-sm text-slate-400"><span id="recordCount">0</span> records loaded</p>
                </div>
              </div>
              <button id="clearFileBtn" class="text-slate-400 hover:text-red-400 transition-colors p-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Search Section -->
      <section id="searchSection" class="bg-slate-900/50 rounded-2xl border border-slate-800/50 overflow-hidden opacity-50 pointer-events-none transition-opacity">
        <div class="px-6 py-4 border-b border-slate-800/50">
          <h2 class="text-sm font-medium text-slate-300 uppercase tracking-wider">Search & Filter</h2>
        </div>
        <div class="p-6 space-y-5">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="md:col-span-2">
              <label class="block text-sm font-medium text-slate-400 mb-2">Search Query</label>
              <div class="relative">
                <svg class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                <input type="text" id="searchQuery" placeholder="Enter search term..." class="w-full pl-12 pr-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all">
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-400 mb-2">Field</label>
              <select id="searchField" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all appearance-none cursor-pointer">
                <option value="_all">All Fields</option>
              </select>
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-6">
            <label class="flex items-center gap-3 cursor-pointer group">
              <div class="relative">
                <input type="checkbox" id="caseSensitive" class="sr-only peer">
                <div class="w-5 h-5 border-2 border-slate-600 rounded-md peer-checked:bg-cyan-500 peer-checked:border-cyan-500 transition-all"></div>
                <svg class="absolute inset-0 w-5 h-5 text-white opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <span class="text-slate-300 group-hover:text-white transition-colors">Case Sensitive</span>
            </label>
            <label class="flex items-center gap-3 cursor-pointer group">
              <div class="relative">
                <input type="checkbox" id="exactMatch" class="sr-only peer">
                <div class="w-5 h-5 border-2 border-slate-600 rounded-md peer-checked:bg-cyan-500 peer-checked:border-cyan-500 transition-all"></div>
                <svg class="absolute inset-0 w-5 h-5 text-white opacity-0 peer-checked:opacity-100 transition-opacity" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                </svg>
              </div>
              <span class="text-slate-300 group-hover:text-white transition-colors">Exact Match</span>
            </label>
          </div>

          <div class="flex gap-3 pt-2">
            <button id="searchBtn" class="px-6 py-3 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-medium rounded-xl hover:from-cyan-400 hover:to-blue-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 transition-all flex items-center gap-2">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
              </svg>
              Search
            </button>
            <button id="resetBtn" class="px-6 py-3 bg-slate-800 text-slate-300 font-medium rounded-xl hover:bg-slate-700 hover:text-white focus:outline-none focus:ring-2 focus:ring-slate-500/50 transition-all">
              Reset
            </button>
          </div>
        </div>
      </section>

      <!-- Data Preview Section -->
      <section id="dataPreviewSection" class="hidden bg-slate-900/50 rounded-2xl border border-slate-800/50 overflow-hidden">
        <div class="px-6 py-4 border-b border-slate-800/50 flex items-center justify-between">
          <div class="flex items-center gap-3">
            <h2 class="text-sm font-medium text-slate-300 uppercase tracking-wider" id="previewTitle">Data Preview</h2>
            <span id="searchBadge" class="hidden px-2 py-0.5 bg-cyan-500/10 text-cyan-400 rounded-md text-xs font-medium">Search Results</span>
          </div>
          <div class="flex items-center gap-4">
            <div class="flex items-center gap-2 text-sm">
              <span class="text-slate-400">Showing</span>
              <select id="previewPageSize" class="px-2 py-1 bg-slate-800 border border-slate-700 rounded-lg text-white text-sm focus:outline-none">
                <option value="10">10</option>
                <option value="25">25</option>
                <option value="50" selected>50</option>
                <option value="100">100</option>
              </select>
              <span class="text-slate-400">per page</span>
            </div>
            <span class="text-slate-400 text-sm">
              <span id="previewShowing">0</span> of <span id="previewTotal">0</span> records
            </span>
          </div>
        </div>
        <div class="p-6">
          <div class="overflow-hidden rounded-xl border border-slate-700/50">
            <div class="overflow-y-auto max-h-[32rem]">
              <table class="w-full text-sm table-fixed">
                <thead id="previewTableHead" class="bg-slate-800/80 sticky top-0">
                </thead>
                <tbody id="previewTableBody" class="divide-y divide-slate-800">
                </tbody>
              </table>
            </div>
          </div>
          <!-- Pagination -->
          <div class="flex items-center justify-between mt-4">
            <div class="text-sm text-slate-400">
              Page <span id="previewCurrentPage">1</span> of <span id="previewTotalPages">1</span>
            </div>
            <div class="flex gap-2">
              <button id="previewFirstBtn" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"/></svg>
              </button>
              <button id="previewPrevBtn" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
              </button>
              <button id="previewNextBtn" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
              </button>
              <button id="previewLastBtn" class="px-3 py-2 bg-slate-800 text-slate-300 rounded-lg hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- Export Section -->
      <section id="exportSection" class="hidden bg-slate-900/50 rounded-2xl border border-slate-800/50">
        <div class="px-6 py-4 border-b border-slate-800/50">
          <h2 class="text-sm font-medium text-slate-300 uppercase tracking-wider">Export</h2>
        </div>
        <div class="p-6 space-y-4">
          <div class="flex items-center gap-4 text-sm text-slate-400">
            <span>Exporting:</span>
            <span id="exportInfo" class="px-2 py-0.5 bg-cyan-500/10 text-cyan-400 rounded-md font-medium">All data</span>
          </div>

          <!-- Field Selector -->
          <div>
            <label class="block text-sm font-medium text-slate-400 mb-2">Fields to Export</label>
            <div class="relative">
              <button id="fieldSelectorBtn" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white text-left focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all flex items-center justify-between">
                <span id="fieldSelectorText">All Fields</span>
                <svg class="w-5 h-5 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
              </button>
              <div id="fieldDropdown" class="hidden absolute z-10 mt-2 w-full bg-slate-800 border border-slate-700 rounded-xl shadow-xl max-h-64 overflow-y-auto">
                <div class="p-2 border-b border-slate-700">
                  <label class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-700/50 cursor-pointer">
                    <input type="checkbox" id="selectAllFields" checked class="w-4 h-4 rounded border-slate-600 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0 bg-slate-700">
                    <span class="text-white font-medium">Select All</span>
                  </label>
                </div>
                <div id="fieldCheckboxes" class="p-2 space-y-1">
                  <!-- Field checkboxes will be populated here -->
                </div>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
            <div class="md:col-span-3">
              <label class="block text-sm font-medium text-slate-400 mb-2">Save Directory</label>
              <input type="text" id="saveDir" placeholder="Leave empty for uploads folder" class="w-full px-4 py-3 bg-slate-800/50 border border-slate-700 rounded-xl text-white placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50 focus:border-cyan-500 transition-all">
            </div>
            <div class="flex gap-2">
              <button id="saveBtn" class="flex-1 px-4 py-3 bg-emerald-600 text-white font-medium rounded-xl hover:bg-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/50 transition-all flex items-center justify-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"/>
                </svg>
                Save
              </button>
              <button id="viewJsonBtn" class="px-4 py-3 bg-slate-800 text-slate-300 font-medium rounded-xl hover:bg-slate-700 hover:text-white focus:outline-none transition-all" title="View JSON">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"/>
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- JSON Preview Modal -->
      <div id="jsonModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-6">
        <div class="absolute inset-0 bg-black/70 backdrop-blur-sm" id="modalBackdrop"></div>
        <div class="relative w-full max-w-4xl max-h-[80vh] bg-slate-900 rounded-2xl border border-slate-700 overflow-hidden flex flex-col">
          <div class="px-6 py-4 border-b border-slate-800 flex items-center justify-between">
            <h3 class="font-medium text-white">JSON Preview</h3>
            <button id="closeModalBtn" class="text-slate-400 hover:text-white transition-colors p-1">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
          <div class="flex-1 overflow-auto p-6">
            <pre id="jsonPreview" class="text-sm text-slate-300 font-mono whitespace-pre-wrap"></pre>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-6 right-6 transform translate-y-20 opacity-0 transition-all duration-300 z-50">
    <div class="px-5 py-3 rounded-xl shadow-xl flex items-center gap-3">
      <div id="toastIcon"></div>
      <span id="toastMessage" class="font-medium"></span>
    </div>
  </div>

  <script>
    // State
    let jsonData = null;
    let searchResults = null;
    let currentQuery = '';
    let availableFields = [];
    let selectedFields = new Set();

    // Pagination state
    let previewPage = 1;
    let previewPageSize = 50;

    // Elements
    const uploadArea = document.getElementById('uploadArea');
    const fileInput = document.getElementById('fileInput');
    const fileInfo = document.getElementById('fileInfo');
    const fileName = document.getElementById('fileName');
    const recordCount = document.getElementById('recordCount');
    const clearFileBtn = document.getElementById('clearFileBtn');
    const searchSection = document.getElementById('searchSection');
    const searchQuery = document.getElementById('searchQuery');
    const searchField = document.getElementById('searchField');
    const caseSensitive = document.getElementById('caseSensitive');
    const exactMatch = document.getElementById('exactMatch');
    const searchBtn = document.getElementById('searchBtn');
    const resetBtn = document.getElementById('resetBtn');
    const searchBadge = document.getElementById('searchBadge');
    const saveBtn = document.getElementById('saveBtn');
    const saveDir = document.getElementById('saveDir');
    const viewJsonBtn = document.getElementById('viewJsonBtn');
    const jsonModal = document.getElementById('jsonModal');
    const jsonPreview = document.getElementById('jsonPreview');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const fieldSelectorBtn = document.getElementById('fieldSelectorBtn');
    const fieldSelectorText = document.getElementById('fieldSelectorText');
    const fieldDropdown = document.getElementById('fieldDropdown');
    const fieldCheckboxes = document.getElementById('fieldCheckboxes');
    const selectAllFields = document.getElementById('selectAllFields');

    // Data preview elements
    const dataPreviewSection = document.getElementById('dataPreviewSection');
    const previewTableHead = document.getElementById('previewTableHead');
    const previewTableBody = document.getElementById('previewTableBody');
    const previewPageSizeSelect = document.getElementById('previewPageSize');
    const previewShowing = document.getElementById('previewShowing');
    const previewTotal = document.getElementById('previewTotal');
    const previewCurrentPage = document.getElementById('previewCurrentPage');
    const previewTotalPages = document.getElementById('previewTotalPages');
    const previewFirstBtn = document.getElementById('previewFirstBtn');
    const previewPrevBtn = document.getElementById('previewPrevBtn');
    const previewNextBtn = document.getElementById('previewNextBtn');
    const previewLastBtn = document.getElementById('previewLastBtn');

    // Export section elements
    const exportSection = document.getElementById('exportSection');
    const exportInfo = document.getElementById('exportInfo');

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('border-cyan-500', 'bg-cyan-500/10');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('border-cyan-500', 'bg-cyan-500/10');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('border-cyan-500', 'bg-cyan-500/10');
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.json')) {
        handleFile(file);
      } else {
        showToast('Please upload a JSON file', 'error');
      }
    });

    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFile(file);
    });

    clearFileBtn.addEventListener('click', () => {
      jsonData = null;
      searchResults = null;
      fileInfo.classList.add('hidden');
      searchSection.classList.add('opacity-50', 'pointer-events-none');
      dataPreviewSection.classList.add('hidden');
      exportSection.classList.add('hidden');
      searchBadge.classList.add('hidden');
      fileInput.value = '';
    });

    // Preview pagination
    previewPageSizeSelect.addEventListener('change', () => {
      previewPageSize = parseInt(previewPageSizeSelect.value);
      previewPage = 1;
      renderPreviewTable();
    });

    previewFirstBtn.addEventListener('click', () => { previewPage = 1; renderPreviewTable(); });
    previewPrevBtn.addEventListener('click', () => { if (previewPage > 1) { previewPage--; renderPreviewTable(); } });
    previewNextBtn.addEventListener('click', () => {
      const data = searchResults || jsonData;
      const totalPages = Math.ceil(data.length / previewPageSize);
      if (previewPage < totalPages) { previewPage++; renderPreviewTable(); }
    });
    previewLastBtn.addEventListener('click', () => {
      const data = searchResults || jsonData;
      previewPage = Math.ceil(data.length / previewPageSize);
      renderPreviewTable();
    });

    function renderPreviewTable() {
      const data = searchResults || jsonData;
      if (!data || data.length === 0) return;

      const totalPages = Math.ceil(data.length / previewPageSize);
      const start = (previewPage - 1) * previewPageSize;
      const end = Math.min(start + previewPageSize, data.length);
      const pageData = data.slice(start, end);

      // Update pagination info
      previewShowing.textContent = `${start + 1}-${end}`;
      previewTotal.textContent = data.length;
      previewCurrentPage.textContent = previewPage;
      previewTotalPages.textContent = totalPages;

      // Update button states
      previewFirstBtn.disabled = previewPage === 1;
      previewPrevBtn.disabled = previewPage === 1;
      previewNextBtn.disabled = previewPage === totalPages;
      previewLastBtn.disabled = previewPage === totalPages;

      // Render table
      renderTableGeneric(pageData, previewTableHead, previewTableBody);
    }

    function renderTableGeneric(data, headEl, bodyEl) {
      if (!data || data.length === 0) {
        headEl.innerHTML = '';
        bodyEl.innerHTML = '<tr><td class="px-4 py-8 text-center text-slate-500">No data</td></tr>';
        return;
      }

      const keys = new Set();
      data.forEach(item => {
        if (typeof item === 'object' && item !== null) {
          Object.keys(item).forEach(key => keys.add(key));
        }
      });

      const columns = Array.from(keys).slice(0, 10);

      headEl.innerHTML = '<tr>' +
        columns.map(col => `<th class="px-4 py-3 text-left text-xs font-semibold text-slate-300 uppercase tracking-wider">${col}</th>`).join('') +
        '</tr>';

      bodyEl.innerHTML = data.map(item => {
        if (typeof item !== 'object' || item === null) {
          return `<tr class="hover:bg-slate-800/50"><td colspan="${columns.length}" class="px-4 py-3 text-slate-300 break-words">${JSON.stringify(item)}</td></tr>`;
        }
        return '<tr class="hover:bg-slate-800/50">' +
          columns.map(col => {
            let value = item[col];
            if (value === undefined || value === null) return '<td class="px-4 py-3 text-slate-500">-</td>';
            if (typeof value === 'object') value = JSON.stringify(value);
            return `<td class="px-4 py-3 text-slate-300 break-words max-w-xs">${escapeHtml(String(value))}</td>`;
          }).join('') +
          '</tr>';
      }).join('');
    }

    async function handleFile(file) {
      const formData = new FormData();
      formData.append('jsonFile', file);

      try {
        const response = await fetch('/api/upload', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (data.success) {
          jsonData = Array.isArray(data.data) ? data.data : [data.data];
          searchResults = null; // Reset search results
          searchBadge.classList.add('hidden');
          searchQuery.value = ''; // Clear search query
          fileName.textContent = data.filename;
          recordCount.textContent = data.recordCount;
          fileInfo.classList.remove('hidden');
          searchSection.classList.remove('opacity-50', 'pointer-events-none');
          dataPreviewSection.classList.remove('hidden');
          exportSection.classList.remove('hidden');

          previewPage = 1;
          renderPreviewTable();
          await loadFields();
          populateFieldSelector(jsonData);
          updateExportInfo();
          showToast('File loaded successfully', 'success');
        } else {
          showToast(data.error, 'error');
        }
      } catch (error) {
        showToast('Error uploading file: ' + error.message, 'error');
      }
    }

    async function loadFields() {
      try {
        const response = await fetch('/api/fields');
        const data = await response.json();

        searchField.innerHTML = '';
        data.fields.forEach(field => {
          const option = document.createElement('option');
          option.value = field;
          option.textContent = field === '_all' ? 'All Fields' : field;
          searchField.appendChild(option);
        });
      } catch (error) {
        console.error('Error loading fields:', error);
      }
    }

    searchBtn.addEventListener('click', search);
    searchQuery.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') search();
    });

    async function search() {
      const query = searchQuery.value.trim();
      currentQuery = query;

      try {
        const response = await fetch('/api/search', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            query,
            field: searchField.value,
            caseSensitive: caseSensitive.checked,
            exactMatch: exactMatch.checked
          })
        });

        const data = await response.json();

        if (data.success) {
          searchResults = data.results;

          previewPage = 1;
          renderPreviewTable();
          populateFieldSelector(data.results);
          updateExportInfo();
          searchBadge.classList.remove('hidden');

          showToast(`Found ${data.matchCount} matching records`, 'success');
        } else {
          showToast(data.error, 'error');
        }
      } catch (error) {
        showToast('Search error: ' + error.message, 'error');
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    resetBtn.addEventListener('click', () => {
      searchQuery.value = '';
      caseSensitive.checked = false;
      exactMatch.checked = false;
      searchField.value = '_all';
      searchResults = null;
      searchBadge.classList.add('hidden');
      if (jsonData) {
        previewPage = 1;
        renderPreviewTable();
        populateFieldSelector(jsonData);
        updateExportInfo();
      }
    });

    saveBtn.addEventListener('click', async () => {
      const dataToExport = searchResults || jsonData;
      if (!dataToExport) {
        showToast('No data to save', 'error');
        return;
      }

      if (selectedFields.size === 0) {
        showToast('Please select at least one field', 'error');
        return;
      }

      const filteredResults = filterResultsByFields(dataToExport);

      try {
        const response = await fetch('/api/save', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            results: filteredResults,
            query: currentQuery || 'all',
            saveDir: saveDir.value || null
          })
        });

        const data = await response.json();

        if (data.success) {
          showToast(`Saved: ${data.filename}`, 'success');
        } else {
          showToast(data.error, 'error');
        }
      } catch (error) {
        showToast('Save error: ' + error.message, 'error');
      }
    });

    viewJsonBtn.addEventListener('click', () => {
      const dataToExport = searchResults || jsonData;
      if (dataToExport) {
        const filteredResults = filterResultsByFields(dataToExport);
        jsonPreview.textContent = JSON.stringify(filteredResults, null, 2);
        jsonModal.classList.remove('hidden');
      }
    });

    function updateExportInfo() {
      if (searchResults) {
        exportInfo.textContent = `${searchResults.length} search results`;
      } else if (jsonData) {
        exportInfo.textContent = `All ${jsonData.length} records`;
      } else {
        exportInfo.textContent = 'No data';
      }
    }

    closeModalBtn.addEventListener('click', () => jsonModal.classList.add('hidden'));
    modalBackdrop.addEventListener('click', () => jsonModal.classList.add('hidden'));

    // Field selector dropdown
    fieldSelectorBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      fieldDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
      if (!fieldDropdown.contains(e.target) && e.target !== fieldSelectorBtn) {
        fieldDropdown.classList.add('hidden');
      }
    });

    selectAllFields.addEventListener('change', () => {
      const checkboxes = fieldCheckboxes.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        cb.checked = selectAllFields.checked;
        if (selectAllFields.checked) {
          selectedFields.add(cb.value);
        } else {
          selectedFields.delete(cb.value);
        }
      });
      updateFieldSelectorText();
    });

    function populateFieldSelector(data) {
      if (!data || data.length === 0) return;

      const keys = new Set();
      data.forEach(item => {
        if (typeof item === 'object' && item !== null) {
          Object.keys(item).forEach(key => keys.add(key));
        }
      });

      availableFields = Array.from(keys);
      selectedFields = new Set(availableFields); // Default: all selected

      fieldCheckboxes.innerHTML = availableFields.map(field => `
        <label class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-slate-700/50 cursor-pointer">
          <input type="checkbox" value="${field}" checked class="field-checkbox w-4 h-4 rounded border-slate-600 text-cyan-500 focus:ring-cyan-500 focus:ring-offset-0 bg-slate-700">
          <span class="text-slate-300">${field}</span>
        </label>
      `).join('');

      // Add event listeners to checkboxes
      fieldCheckboxes.querySelectorAll('.field-checkbox').forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) {
            selectedFields.add(cb.value);
          } else {
            selectedFields.delete(cb.value);
          }
          updateSelectAllState();
          updateFieldSelectorText();
        });
      });

      selectAllFields.checked = true;
      updateFieldSelectorText();
    }

    function updateSelectAllState() {
      const checkboxes = fieldCheckboxes.querySelectorAll('.field-checkbox');
      const allChecked = Array.from(checkboxes).every(cb => cb.checked);
      const someChecked = Array.from(checkboxes).some(cb => cb.checked);
      selectAllFields.checked = allChecked;
      selectAllFields.indeterminate = someChecked && !allChecked;
    }

    function updateFieldSelectorText() {
      if (selectedFields.size === 0) {
        fieldSelectorText.textContent = 'No fields selected';
      } else if (selectedFields.size === availableFields.length) {
        fieldSelectorText.textContent = 'All Fields';
      } else {
        fieldSelectorText.textContent = `${selectedFields.size} of ${availableFields.length} fields`;
      }
    }

    function filterResultsByFields(results) {
      if (selectedFields.size === availableFields.length) {
        return results; // All fields selected, return as-is
      }

      return results.map(item => {
        if (typeof item !== 'object' || item === null) return item;
        const filtered = {};
        for (const field of selectedFields) {
          if (field in item) {
            filtered[field] = item[field];
          }
        }
        return filtered;
      });
    }

    function showToast(message, type) {
      const toast = document.getElementById('toast');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');

      const styles = {
        success: {
          bg: 'bg-emerald-600',
          icon: '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>'
        },
        error: {
          bg: 'bg-red-600',
          icon: '<svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>'
        }
      };

      const style = styles[type] || styles.success;

      toast.querySelector('div').className = `px-5 py-3 rounded-xl shadow-xl flex items-center gap-3 ${style.bg}`;
      toastIcon.innerHTML = style.icon;
      toastMessage.textContent = message;
      toastMessage.className = 'font-medium text-white';

      toast.classList.remove('translate-y-20', 'opacity-0');

      setTimeout(() => {
        toast.classList.add('translate-y-20', 'opacity-0');
      }, 3000);
    }
  </script>
</body>
</html>
